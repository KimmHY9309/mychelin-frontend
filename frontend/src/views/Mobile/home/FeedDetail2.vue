<template>
    <div>
        <SweetModal ref="modal2">
            <textarea name="" id="" cols="" rows="" style="width:90%; height:70vw; border:1px solid black;" v-bind:value="editpost" v-on:input="updateeditPost">내용</textarea>
            <button type="button" v-on:click="editPosting(feed.postId)">수정하기</button>
        </SweetModal>

        <div class="row border pt-3 px-2">
            <!-- 게시글 작성자, 작성일 정보 -->
            <div class="row mb-3">
                <div class="col-2" v-on:click="clickProfile(feed.userNickname)">
                    <img class="img-full-round" :src="feed.profileImage" />	
                </div>
                <div class="col-6">
                    <p style="text-align:left"> 
                        <span class="text-big me-3">{{ feed.userNickname }}</span> 
                        <i class="fas fa-users" style="color:#BDBDBD"></i>
                        <span style="color:#BDBDBD">&nbsp;{{ feed.userFollowerCnt }}</span>
                    </p>
                </div>
                <div class="offset-1 col-3 text-secondary" style="text-align:right; padding:0;">
                    {{ feed.createDate}}<br>
                    <button type="button" v-if="mynickname === feed.userNickname" v-on:click="modifyFeedModal(feed.contentFront, feed.contentBack)" style="font-size:3vw; color:#C4C4C4;">수정&nbsp;</button>
                    <button type="button" v-if="mynickname === feed.userNickname" v-on:click="deleteFeed(feed.postId)" style="font-size:3vw; color:#C4C4C4;">&nbsp;삭제</button>
                </div>
                
            </div>
            <!-- 게시글 내용 -->
            <div style="position:relative"  v-if="feed.images.length">
                <img class="img-full mb-3" :src="feed.contentPic"/>
                <button class="feed-image-tag" v-if="placeId" v-on:click="godetail(feed.placeId, 1)"><i class="far fa-flag"></i>&nbsp;{{placeId}}</button>
                <button class="feed-image-tag-list" v-if="placeListId" v-on:click="godetail(feed.placeListId, 2)"><i class="far fa-map"></i>&nbsp;{{placeListId}}</button>
            </div>
            <div style="padding-left:0" v-else>
                <button class="feed-image-none-image" v-if="placeId" v-on:click="godetail(feed.placeId, 1)"><i class="far fa-flag"></i>&nbsp;{{placeId}}</button>
                <button class="feed-image-none-image" v-if="placeListId" v-on:click="godetail(feed.placeListId, 2)"><i class="far fa-map"></i>&nbsp;{{placeListId}}</button>
            </div>
            <p style="text-align:left"><span>{{ feed.contentFront }}</span>
                <span class="text-secondary" v-if="backContentVisible" v-on:click="clickMore(feed)">...더보기</span>
                <span v-if="!backContentVisible">{{ feed.contentBack }}</span>
            </p>
            <p>
                <span class="text-secondary" v-if="foldBtnVisible" v-on:click="clickFold(feed)">접기</span>
            </p>
            <div class="row">
                <div class="col-1" style="display:flex;">
                    <button class="icon" type="button" >
                        <div v-show="!isLiked" v-on:click="wirteLike(feed.postId, 1)">
                            <i class="far fa-heart"></i>
                        </div>
                        <div v-show="isLiked" v-on:click="wirteLike(feed.postId, 0)">
                            <i class="fas fa-heart" style="color:orange"></i>
                        </div>
                    </button>
                    <button style="color:#363636; font-size:17px;">&nbsp;&nbsp;{{ likecount }}&nbsp;&nbsp;&nbsp;</button>
                    <!--<button>&nbsp;&nbsp;</button>-->
                    <button class="icon" v-on:click="writeComment(feed.postId)"><i class="far fa-comment-alt"></i></button>
                    <button  v-on:click="writeComment(feed.postId)" style="color:#363636; font-size:17px;">&nbsp;&nbsp;{{feed.commentCnt}}</button>
                </div>
            </div>
            <div class="row" v-if="feed.commentCnt">
                <div class="col-13" style="word-break:break-all; text-align:left" v-for="com in feed.comments" v-bind:key="com.id">
                    <span style="font-weight:bold;">{{com.writerId}}</span><span>&nbsp;&nbsp;{{com.message}}</span>
                </div>
            </div>
            <div class="row" v-if="feed.commentCnt" v-on:click="writeComment(feed.postId)">
                <div class="col-5" style="color:#C4C4C4">댓글 모두 보기</div>
            </div>
            <!-- 댓글 부분 
            <div class="row border py-2" style="margin:auto;">
                <div class="col-2">
                    <img class="img-full-round" :src="feed.profilePic" />	
                </div>
                <div class="col-9 d-flex align-items-center justify-content-between">
                    <div class="d-flex text-secondary">
                        <input class="input-simple" type="text" placeholder="댓글을 입력하세요." v-on:click="writeComment(feed.postId)"/>
                    </div>
                    <div>
                        <span class="icon"><i class="far fa-paper-plane"></i></span>
                    </div>
                </div>
            </div>-->
            <!-- 게시글 사이 간격 -->
            <div class="term">
            </div>
        </div>
    </div>
</template>

<script>
import { SweetModal } from 'sweet-modal-vue'
import PostsApi from '@/apis/PostsApi'
import PostingApi from '@/apis/PostingApi'
import PlaceApi from '@/apis/PlaceApi'
export default {
    components: {
        SweetModal
    },
    props: {
        feed: Object
    },
    computed: {
        backContentVisible(){
            return this.feed.long;
        },
        foldBtnVisible(){
			if (this.feed.contentBack === "") return false;
			else return !this.feed.long;
		},
        mynickname(){
            return localStorage.getItem("nickname");
        },
        placeId(){
            return this.placeid;
        },
        placeListId(){
            return this.placelistid;
        },
        likeCount(){
            return this.feed.likeCnt;
        }
    },
    methods: {
		clickProfile(nickname){
			this.$router.push({ name: 'Profile', params: { id: nickname }})
		},
		writeComment(id){
			this.$router.push({ name: 'Comment', params: { id: id}});
		},
        wirteLike(id, num){
			PostsApi.requestPostLike(id, res=>{
                //window.swal("좋아요")
            }, err =>{window.swal("ERROR")});
            this.isLiked = !this.isLiked
            if(num == 1) this.likecount += 1
            if(num == 0) this.likecount -= 1
		},
        clickMore(feed) {
			feed.long = false;
		},
		clickFold(feed) {
			feed.long = true;
		},
        deleteFeed(id){
            PostingApi.requestdeletePosting(id, call => {
                window.swal("", "글을 삭제했습니다","success").then(() => {this.$router.go();});
                }, err => {
                    window.swal("", "삭제하지 못 했습니다 :(", "error").then(() => {this.$router.go();});
                });
        },
        godetail(id, num){
            if(num == 1){
                this.$router.push({ name: 'Place', params: { id: id }})
            }else if(num == 2){
                this.$router.push({ name: 'Mychelin', params: { id: id }})
            }
        },
        modifyFeedModal(fd, ed){
            this.editpost = fd + ed;
            this.$refs.modal2.open();
        },
        updateeditPost:function(e){
            let updatededitReview = e.target.value;
            this.editpost = updatededitReview;
        },
        editPosting(id){
            let data = {
                "content": this.editpost,
                "id": id
            }
            PostingApi.requestEditPosting(data, call => {
                window.swal("", "글을 수정했습니다","success").then(() => {this.$router.go();});
                }, err => {
                    window.swal("", "수정하지 못 했습니다 :(", "error").then(() => {this.$router.go();});
                });
        },
	},
    created() {
        
    },
    mounted(){
        
    },
    updated(){
        let id = this.feed.placeId;
        if(!id) this.placeid = null;
        if(id){
            PlaceApi.requestPlaceSimple(id).then(res => {
                this.placeid = res.data.data.name;
            })
        }
        let id2 = this.feed.placeListId;
        if(!id2) this.placelistid = null;
        if(id2){
            PlaceApi.requestPlaceListSimple(id2).then(res => {
                this.placelistid = res.data.data.title;
            })
        }
        
        if(!this.up){
        this.likecount = this.feed.likeCnt;
        this.isLiked = this.feed.liked;
        this.commentcount = this.feed.commentCnt;
        this.up+=1;
        }
        
    },
    data: () =>{
        return{
            placeid:null,
            placelistid:null,
            editpost:"",
            likecount:0,
            commentcount:0,
            isLiked:false,
            up: 0,
        }
    }
}
</script>

<style>
.feed-image-tag{
    position:absolute;
    bottom:9.66vw;
    left:7.25vw;
    color:white;
    background: rgba(16, 16, 16, 0.5);
    border-radius: 2.42vw;
    padding:0.24vw 2.42vw 0.24vw 2.42vw;
}
.feed-image-tag-list{
    position:absolute;
    bottom:9.66vw;
    right:7.25vw;
    color:white;
    background: rgba(16, 16, 16, 0.5);
    border-radius: 2.42vw;
    padding:0.24vw 2.42vw 0.24vw 2.42vw;
}
.display-none{
    display: none;
}
</style>